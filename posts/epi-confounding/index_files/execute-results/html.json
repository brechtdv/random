{
  "hash": "fb16f2d2e61fe71579323678501f0c15",
  "result": {
    "markdown": "---\ntitle: \"Confounding\"\ndescription: \"Identifying and addressing confounding in observational data\"\ndate: \"2024-10-23\"\n---\n\n\n# Dummy dataset\n\nTo demonstrate confounding in the relationship between coffee consumption and cardiovascular disease (CVD), using tobacco as a confounder, we first generate a dummy dataset with three variables: coffee consumption, CVD status, and tobacco use. We will assume that tobacco use affects both coffee consumption and the likelihood of CVD.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Settings\nset.seed(123)  # for reproducibility\nn <- 500       # number of iterations\n\n# Generate tobacco use (confounder)\ntobacco <- rbinom(n, 1, 0.4)  # 40% smokers\n\n# Generate coffee consumption based on tobacco use (confounder effect)\n# Smokers are more likely to drink coffee\ncoffee <- rbinom(n, 1, prob = 0.2 + 0.5 * tobacco)  \n\n# Generate CVD based on tobacco use and coffee consumption\n# Tobacco is a stronger predictor of CVD\nCVD <- rbinom(n, 1, prob = 0.1 + 0.3 * tobacco + 0.05 * coffee)\n\n# Create the data frame\ndata <- data.frame(coffee, tobacco, CVD)\n\n# Examine the first few rows of the dataset\nhead(data)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  coffee tobacco CVD\n1      0       0   0\n2      1       1   1\n3      0       0   0\n4      1       1   1\n5      1       1   1\n6      0       0   0\n```\n:::\n:::\n\n\n# Visualising confounding\n\nTo visually check for confounding in the relationship between coffee consumption and cardiovascular disease (CVD), we can use several types of plots in R. These plots help illustrate how the confounder (tobacco) influences both the exposure (coffee consumption) and the outcome (CVD).\n\n## Correlation heatmap\n\nThe pairwise correlations between the variables can be visualised in a heatmap:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load the required package\nlibrary(ggcorrplot)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nLoading required package: ggplot2\n```\n:::\n\n```{.r .cell-code}\n# Compute the correlation matrix\ncorr_matrix <- cor(data)\n\n# Plot the correlation heatmap\nggcorrplot(\n  corr_matrix, method = \"circle\",\n  lab = TRUE, title = \"Correlation Matrix: Coffee, Tobacco, and CVD\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\nInterpretation:\n\n- Coffee and Tobacco have a moderate positive correlation, as expected, since smokers are more likely to drink coffee in this simulated dataset.\n- Tobacco and CVD show a stronger positive correlation, reflecting that smoking increases the risk of cardiovascular disease.\n- Coffee and CVD have a weaker positive correlation, which may be confounded by tobacco use.\n    \n## Scatterplot with Grouping (Exposure vs. Outcome with Confounder Grouping)\n\nA scatterplot or barplot that groups the data by the confounder (tobacco) can visually show the confounding effect. In this case, we can plot the relationship between coffee and CVD, with separate lines or bars for smokers and non-smokers.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggplot2)\n\n# Create a bar plot showing CVD rate by coffee consumption, stratified by tobacco use\nggplot(data, aes(x = factor(coffee), fill = factor(CVD))) +\n  geom_bar(position = \"fill\") +\n  facet_wrap(~ tobacco, labeller = labeller(tobacco = c(\"0\" = \"Non-smokers\", \"1\" = \"Smokers\"))) +\n  labs(x = \"Coffee Consumption\", fill = \"CVD Status\", y = \"Proportion\") +\n  scale_fill_manual(values = c(\"0\" = \"lightblue\", \"1\" = \"red\")) +\n  ggtitle(\"CVD Proportion by Coffee Consumption (Stratified by Tobacco Use)\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\nThis plot shows how the relationship between coffee and CVD changes when stratified by tobacco use. If there is confounding, the relationship between coffee and CVD should look different for smokers and non-smokers.\n\nVice versa, we can plot the relationship between tobacco use and CVD, stratified by coffee consumption. If there is confounding, the relationship between tobacco and CVD should look similar for coffee consumers and non-consumers.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create a bar plot showing CVD rate by coffee consumption, stratified by tobacco use\nggplot(data, aes(x = factor(tobacco), fill = factor(CVD))) +\n  geom_bar(position = \"fill\") +\n  facet_wrap(~ coffee, labeller = labeller(coffee = c(\"0\" = \"No coffee\", \"1\" = \"Coffee\"))) +\n  labs(x = \"Tobacco use\", fill = \"CVD Status\", y = \"Proportion\") +\n  scale_fill_manual(values = c(\"0\" = \"lightblue\", \"1\" = \"red\")) +\n  ggtitle(\"CVD Proportion by Tobacco use (Stratified by Coffee Consumption)\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n## Interaction Plot (Coffee, CVD, and Tobacco)\n\nAn interaction plot can help visually assess whether there is an interaction effect between coffee consumption and tobacco use on the likelihood of CVD. It shows the predicted probabilities or the mean CVD rate across different groups.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Calculate mean CVD rate by coffee and tobacco groups\nmean_cvd <- aggregate(CVD ~ coffee + tobacco, data = data, FUN = mean)\n\n# Interaction plot\nggplot(mean_cvd, aes(x = factor(coffee), y = CVD, color = factor(tobacco), group = tobacco)) +\n  geom_line(linewidth = 1.2) +\n  geom_point(linewidth = 3) +\n  labs(x = \"Coffee Consumption\", y = \"Mean CVD Rate\", color = \"Tobacco Use\") +\n  ggtitle(\"Interaction Plot: Coffee Consumption, Tobacco, and Mean CVD Rate\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in geom_point(linewidth = 3): Ignoring unknown parameters: `linewidth`\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\nThis plot illustrates how the relationship between coffee consumption and CVD varies by tobacco use. If tobacco is a confounder, the slopes for smokers and non-smokers should differ, suggesting that the effect of coffee on CVD is not the same for both groups.\n\n# Model-based identification of confounding\n\nWe can analyze the relationship between coffee and CVD without adjusting for tobacco use and then include tobacco use to observe its confounding effect.\n\nFirst, we can see if there is a relationship between coffee consumption and CVD without considering tobacco as a confounder.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Unadjusted model (coffee vs CVD)\nunadjusted_model <- glm(CVD ~ coffee, data = data, family = \"binomial\")\nsummary(unadjusted_model)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nglm(formula = CVD ~ coffee, family = \"binomial\", data = data)\n\nCoefficients:\n            Estimate Std. Error z value Pr(>|z|)    \n(Intercept)  -1.8036     0.1665  -10.83  < 2e-16 ***\ncoffee        1.2051     0.2219    5.43 5.64e-08 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 536.85  on 499  degrees of freedom\nResidual deviance: 506.09  on 498  degrees of freedom\nAIC: 510.09\n\nNumber of Fisher Scoring iterations: 4\n```\n:::\n:::\n\n\nThis will give us the log odds ratio for the effect of coffee consumption on CVD without considering tobacco.\n\nNow, we adjust for tobacco use to see if the relationship between coffee and CVD changes after accounting for the confounder.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Adjusted model (coffee vs CVD, adjusting for tobacco)\nadjusted_model <- glm(CVD ~ coffee + tobacco, data = data, family = \"binomial\")\nsummary(adjusted_model)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nglm(formula = CVD ~ coffee + tobacco, family = \"binomial\", data = data)\n\nCoefficients:\n            Estimate Std. Error z value Pr(>|z|)    \n(Intercept)  -2.3239     0.2057 -11.298  < 2e-16 ***\ncoffee        0.4377     0.2582   1.696     0.09 .  \ntobacco       1.7344     0.2666   6.507 7.68e-11 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 536.85  on 499  degrees of freedom\nResidual deviance: 459.82  on 497  degrees of freedom\nAIC: 465.82\n\nNumber of Fisher Scoring iterations: 4\n```\n:::\n:::\n\n\nBy comparing the coefficients in both models, we can observe the confounding effect of tobacco on the coffee-CVD relationship.\n\n# Approaches to Handle Confounding\n\n## Stratification by tobacco use\n\nWe can stratify the analysis by tobacco use to compare the effect of coffee on CVD within each group (smokers and non-smokers).\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Stratified analysis for non-smokers\nnon_smokers <- subset(data, tobacco == 0)\nstrat_model_ns <- glm(CVD ~ coffee, data = non_smokers, family = \"binomial\")\nsummary(strat_model_ns)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nglm(formula = CVD ~ coffee, family = \"binomial\", data = non_smokers)\n\nCoefficients:\n            Estimate Std. Error z value Pr(>|z|)    \n(Intercept)  -2.2889     0.2237 -10.230   <2e-16 ***\ncoffee        0.3079     0.4385   0.702    0.483    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 196.09  on 304  degrees of freedom\nResidual deviance: 195.62  on 303  degrees of freedom\nAIC: 199.62\n\nNumber of Fisher Scoring iterations: 5\n```\n:::\n\n```{.r .cell-code}\n# Stratified analysis for smokers\nsmokers <- subset(data, tobacco == 1)\nstrat_model_sm <- glm(CVD ~ coffee, data = smokers, family = \"binomial\")\nsummary(strat_model_sm)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nglm(formula = CVD ~ coffee, family = \"binomial\", data = smokers)\n\nCoefficients:\n            Estimate Std. Error z value Pr(>|z|)  \n(Intercept)  -0.6419     0.2763  -2.323   0.0202 *\ncoffee        0.5103     0.3250   1.570   0.1164  \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 266.58  on 194  degrees of freedom\nResidual deviance: 264.06  on 193  degrees of freedom\nAIC: 268.06\n\nNumber of Fisher Scoring iterations: 4\n```\n:::\n:::\n\n\n## Regression adjustment\n\nAs done earlier, logistic regression models can adjust for tobacco use. This method is often more convenient than stratification.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# The adjusted model shown earlier adjusts for tobacco use\nsummary(adjusted_model)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nglm(formula = CVD ~ coffee + tobacco, family = \"binomial\", data = data)\n\nCoefficients:\n            Estimate Std. Error z value Pr(>|z|)    \n(Intercept)  -2.3239     0.2057 -11.298  < 2e-16 ***\ncoffee        0.4377     0.2582   1.696     0.09 .  \ntobacco       1.7344     0.2666   6.507 7.68e-11 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 536.85  on 499  degrees of freedom\nResidual deviance: 459.82  on 497  degrees of freedom\nAIC: 465.82\n\nNumber of Fisher Scoring iterations: 4\n```\n:::\n:::\n\n\n## G-computation\n\nG-computation (or the G-formula) is a causal inference method derived from the counterfactual framework, often used to estimate the causal effect of an exposure on an outcome, adjusting for confounders. G-computation models the outcome (e.g., cardiovascular disease, CVD) under different hypothetical scenarios of the exposure (e.g., coffee consumption) and then averages these over the distribution of confounders (e.g., tobacco use).\n\nThe G-formula provides a direct way to adjust for confounding by estimating the expected outcome for both treated and untreated groups if everyone in the population had the same level of exposure, regardless of their actual exposure. \n\nSteps for G-Computation:\n\n- Fit an outcome model: Model the relationship between the confounder (tobacco), the exposure (coffee), and the outcome (CVD).\n- Predict counterfactual outcomes: Use the model to predict the probability of CVD for everyone in the dataset assuming two different scenarios:\n  - Everyone drank coffee (`coffee = 1`).\n  - No one drank coffee (`coffee = 0`).\n- Estimate the causal effect: Compare the average predicted outcomes under the two scenarios to estimate the causal effect of coffee consumption on CVD.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Fit a logistic regression model for the outcome\noutcome_model <- glm(CVD ~ coffee + tobacco, data = data, family = binomial)\nsummary(outcome_model)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nglm(formula = CVD ~ coffee + tobacco, family = binomial, data = data)\n\nCoefficients:\n            Estimate Std. Error z value Pr(>|z|)    \n(Intercept)  -2.3239     0.2057 -11.298  < 2e-16 ***\ncoffee        0.4377     0.2582   1.696     0.09 .  \ntobacco       1.7344     0.2666   6.507 7.68e-11 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 536.85  on 499  degrees of freedom\nResidual deviance: 459.82  on 497  degrees of freedom\nAIC: 465.82\n\nNumber of Fisher Scoring iterations: 4\n```\n:::\n\n```{.r .cell-code}\n# Create a copy of the data with coffee set to 1 (everyone drinks coffee)\ndata_coffee1 <- data\ndata_coffee1$coffee <- 1\n\n# Predict the probability of CVD for everyone if all drank coffee\npred_coffee1 <- predict(outcome_model, newdata = data_coffee1, type = \"response\")\n\n# Create a copy of the data with coffee set to 0 (no one drinks coffee)\ndata_coffee0 <- data\ndata_coffee0$coffee <- 0\n\n# Predict the probability of CVD for everyone if no one drank coffee\npred_coffee0 <- predict(outcome_model, newdata = data_coffee0, type = \"response\")\n\n# Calculate the mean predicted probability of CVD under both scenarios\nmean_pred_coffee1 <- mean(pred_coffee1)\nmean_pred_coffee0 <- mean(pred_coffee0)\n\n# Calculate the average causal effect (risk difference)\ncausal_effect <- mean_pred_coffee1 - mean_pred_coffee0\ncausal_effect\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.06703175\n```\n:::\n:::\n\n\n\n# R session info\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nR version 4.4.1 (2024-06-14 ucrt)\nPlatform: x86_64-w64-mingw32/x64\nRunning under: Windows 10 x64 (build 19045)\n\nMatrix products: default\n\n\nlocale:\n[1] LC_COLLATE=English_Belgium.utf8  LC_CTYPE=English_Belgium.utf8   \n[3] LC_MONETARY=English_Belgium.utf8 LC_NUMERIC=C                    \n[5] LC_TIME=English_Belgium.utf8    \n\ntime zone: Europe/Brussels\ntzcode source: internal\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n[1] ggcorrplot_0.1.4.1 ggplot2_3.5.1     \n\nloaded via a namespace (and not attached):\n [1] vctrs_0.6.5       cli_3.6.3         knitr_1.48        rlang_1.1.4      \n [5] xfun_0.45         stringi_1.8.4     generics_0.1.3    jsonlite_1.8.8   \n [9] labeling_0.4.3    glue_1.7.0        colorspace_2.1-0  plyr_1.8.9       \n[13] htmltools_0.5.8.1 scales_1.3.0      fansi_1.0.6       rmarkdown_2.27   \n[17] grid_4.4.1        evaluate_0.24.0   munsell_0.5.1     tibble_3.2.1     \n[21] fastmap_1.2.0     reshape2_1.4.4    yaml_2.3.9        lifecycle_1.0.4  \n[25] stringr_1.5.1     compiler_4.4.1    dplyr_1.1.4       Rcpp_1.0.12      \n[29] htmlwidgets_1.6.4 pkgconfig_2.0.3   rstudioapi_0.16.0 farver_2.1.2     \n[33] digest_0.6.36     R6_2.5.1          tidyselect_1.2.1  utf8_1.2.4       \n[37] pillar_1.9.0      magrittr_2.0.3    withr_3.0.0       tools_4.4.1      \n[41] gtable_0.3.5     \n```\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}